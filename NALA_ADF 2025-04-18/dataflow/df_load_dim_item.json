{
	"name": "df_load_dim_item",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "ds_parquet",
						"type": "DatasetReference"
					},
					"name": "SrcInventTable"
				},
				{
					"dataset": {
						"referenceName": "ds_snowflake",
						"type": "DatasetReference"
					},
					"name": "SrcInventHierarchy"
				},
				{
					"dataset": {
						"referenceName": "ds_delimited_csv",
						"type": "DatasetReference"
					},
					"name": "SrcSizeGroupMapping"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "ds_snowflake",
						"type": "DatasetReference"
					},
					"name": "InsertInventTable"
				},
				{
					"dataset": {
						"referenceName": "ds_snowflake",
						"type": "DatasetReference"
					},
					"name": "InventtableHierarchy"
				}
			],
			"transformations": [
				{
					"name": "CompareHash"
				},
				{
					"name": "JoinSizeGroupColumns"
				},
				{
					"name": "SetActiveFlag"
				},
				{
					"name": "InsertItemData"
				},
				{
					"name": "UpsertItemHierarchyData"
				},
				{
					"name": "PullDistinctEntries"
				},
				{
					"name": "RederiveColumns"
				}
			],
			"scriptLines": [
				"parameters{",
				"     df_prev_max_timestamp as string,",
				"     df_last_mod_tmstmp_sizegroupmapping as string",
				"}",
				"source(output(",
				"          DATAAREAID as string,",
				"          ITEMID as string,",
				"          PRODUCT as integer,",
				"          ABCVALUE as integer,",
				"          COSTGROUPID as string,",
				"          DEFAULTDIMENSION as integer,",
				"          CREATEDDATETIME as timestamp,",
				"          MODIFIEDDATETIME as timestamp,",
				"          DATAAREA_TIMEZONE as integer,",
				"          ECORESPRODUCTTRANSLATION_PRODUCT as integer,",
				"          ECORESPRODUCTTRANSLATION_NAME as string,",
				"          ECORESPRODUCTTRANSLATION_MODIFIEDDATETIME as timestamp,",
				"          BOMCOSTGROUP_DATAAREAID as string,",
				"          BOMCOSTGROUP_COSTGROUPID as string,",
				"          BOMCOSTGROUP_NAME as string,",
				"          BOMCOSTGROUP_COSTGROUPBEHAVIOR as integer,",
				"          BOMCOSTGROUP_COSTGROUPTYPE as integer,",
				"          BOMCOSTGROUP_TYPEDEFAULT as integer,",
				"          DEFAULTDIMENSION_E_CATEGORY as string,",
				"          DEFAULTDIMENSION_E_CATEGORY_DESCRIPTION_PARENT as string,",
				"          DEFAULTDIMENSION_E_CATEGORY_DESCRIPTION as string,",
				"          DEFAULTDIMENSION_F_FAMILY as string,",
				"          DEFAULTDIMENSION_F_FAMILY_DESCRIPTION as string,",
				"          DEFAULTDIMENSION_MODIFIEDDATETIME as timestamp,",
				"          TIMEZONEINFO_TIMEZONEID as integer,",
				"          TIMEZONEINFO_STARTDATE as date,",
				"          TIMEZONEINFO_ENDDATE as date,",
				"          TIMEZONEINFO_TIMEBIAS as integer,",
				"          INVENTTABLEMODULE_MODULETYPE as integer,",
				"          INVENTTABLEMODULE_DATAAREAID as string,",
				"          INVENTTABLEMODULE_ITEMID as string,",
				"          INVENTTABLEMODULE_UNITID as string,",
				"          UNITOFMEASURE_RECID as integer,",
				"          UNITOFMEASURE_SYMBOL as string,",
				"          UNITOFMEASURE_MODIFIEDDATETIME as timestamp,",
				"          UNITOFMEASURETRANSLATION_UNITOFMEASURE as integer,",
				"          UNITOFMEASURETRANSLATION_DESCRIPTION as string,",
				"          UNITOFMEASURETRANSLATION_MODIFIEDDATETIME as timestamp,",
				"          TSIPHITEM_DISPLAYPRODUCTNUMBER as string,",
				"          TSIPHITEM_BASEITEMID as string,",
				"          TSIPHITEM_PRODSIZE as string,",
				"          TSIPHBASEITEM_PGCID as string,",
				"          TSIPHBASEITEM_BASEITEMDESCRIPTION as string,",
				"          TSIPHBASEITEM_DEFAULTFDNHIGH as string,",
				"          TSIPHBASEITEM_DEFAULTFDNLOW as string,",
				"          TSIPHBASEITEM_DEFAULTFDNMED as string,",
				"          TSIPHBASEITEM_PIECETYPEID as string,",
				"          TSIPHBASEITEM_PRICECOLLECTIONID as string,",
				"          TSIPHGROUP_PLEVELID as string,",
				"          TSIPHGROUP_PGCDESC as string,",
				"          TSIPHGROUP_ISACTIVE as integer,",
				"          TSIPHGROUP_EFFECTIVEDATE as date,",
				"          TSIPHGROUP_EXPIRATIONDATE as date,",
				"          TSIPHGROUP_MSTRPGCID as string,",
				"          TSIPHGROUP_COMFORTID as string,",
				"          TSIPHGROUP_CONSTRUCTID as string,",
				"          TSIPHLEVEL_LINELAUNCHID as string,",
				"          TSIPHLEVEL_YOYID as string,",
				"          TSIPHLEVEL_PLEVELDESC as string,",
				"          TSIPHLEVEL_ISACTIVE as integer,",
				"          TSIPHLEVEL_ISSPECIALTY as integer,",
				"          TSIPHYEAROVERYEAR_TYPEID as string,",
				"          TSIPHYEAROVERYEAR_PRICEBANDID as string,",
				"          TSIPHYEAROVERYEAR_YOYDESC as string,",
				"          TSIPHTYPE_STYLEID as string,",
				"          TSIPHTYPE_TECHNOLOGYID as string,",
				"          TSIPHTYPE_TYPEDESC as string,",
				"          TSIPHSTYLE_BRANDID as string,",
				"          TSIPHSTYLE_STYLEDESC as string,",
				"          TSIPHBRAND_MBRANDID as string,",
				"          TSIPHBRAND_BRANDDESC as string,",
				"          TSIPHMASTERBRAND_MBRANDDESC as string,",
				"          TSIPHTECHNOLOGY_TECHNOLOGYDESC as string,",
				"          TSIPHPRICEBAND_PRICEBAND as string,",
				"          TSIPHLINELAUNCH_LINELAUNCHDESC as string,",
				"          TSIPHCOMFORT_COMFORTDESC as string,",
				"          TSIPHCONSTRUCTION_CONSTRUCTDESC as string,",
				"          TSIPHPRICECOLLECTION_PRICECOLLECTIONDESC as string,",
				"          TPSSIZE_SIZEID as string,",
				"          TPSSIZE_DIMENSIONS as string,",
				"          TPSSIZE_EBCPANELLENGTH as decimal(32,16),",
				"          TPSSIZE_EBCPANELWIDTH as decimal(32,16),",
				"          TPSSIZE_ACTIVE as integer,",
				"          ITEMGROUPID as string,",
				"          ITEMGROUPNAME as string,",
				"          LAST_MODIFIEDDATETIME as timestamp,",
				"          ITEM_HIERARCHY_HASH_KEY as string,",
				"          BRAND_RANK as integer,",
				"          HK_JOB_RUN_ID as string,",
				"          HK_SOURCE_NAME as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false,",
				"     format: 'parquet') ~> SrcInventTable",
				"source(output(",
				"          HK_ITEM_HIERARCHY_HASH_KEY as string,",
				"          DISPLAYPRODUCTNUMBER as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     query: 'select HK_ITEM_HIERARCHY_HASH_KEY, DISPLAYPRODUCTNUMBER from INVENTTABLE_ITEM_HIERARCHY',",
				"     format: 'query') ~> SrcInventHierarchy",
				"source(output(",
				"          DW_Id as short,",
				"          LegalEntity as string,",
				"          CD_SIZE as string,",
				"          CODE_SIZE as double,",
				"          DES_SIZE as string,",
				"          DES_SIZE_long as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> SrcSizeGroupMapping",
				"SrcInventTable, SrcInventHierarchy join(ITEMID == DISPLAYPRODUCTNUMBER,",
				"     joinType:'left',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'both')~> CompareHash",
				"CompareHash, SrcSizeGroupMapping join(DATAAREAID == LegalEntity",
				"     && TSIPHITEM_PRODSIZE == CD_SIZE,",
				"     joinType:'left',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> JoinSizeGroupColumns",
				"RederiveColumns derive(ACTIVE_FLAG = iif((ITEMID == DISPLAYPRODUCTNUMBER && ITEM_HIERARCHY_HASH_KEY == HK_ITEM_HIERARCHY_HASH_KEY && LASTEST_MODIFIEDDATETIME < toTimestamp($df_prev_max_timestamp)) , 'R',\r",
				"iif((ITEMID == DISPLAYPRODUCTNUMBER && ITEM_HIERARCHY_HASH_KEY == HK_ITEM_HIERARCHY_HASH_KEY && LASTEST_MODIFIEDDATETIME >= toTimestamp($df_prev_max_timestamp)) || (ITEMID == DISPLAYPRODUCTNUMBER && ITEM_HIERARCHY_HASH_KEY != HK_ITEM_HIERARCHY_HASH_KEY), 'U',\r",
				"'I'))) ~> SetActiveFlag",
				"SetActiveFlag filter(ACTIVE_FLAG != 'R') ~> InsertItemData",
				"PullDistinctEntries alterRow(updateIf(ACTIVE_FLAG=='U'),",
				"     insertIf(ACTIVE_FLAG=='I')) ~> UpsertItemHierarchyData",
				"SetActiveFlag filter(BRAND_RANK == 1 && ACTIVE_FLAG != 'R' && isNull(TSIPHITEM_DISPLAYPRODUCTNUMBER) == false()) ~> PullDistinctEntries",
				"JoinSizeGroupColumns derive(LASTEST_MODIFIEDDATETIME = greatest(LAST_MODIFIEDDATETIME,toTimestamp($df_last_mod_tmstmp_sizegroupmapping, 'YYYY-MM-DD HH:MM:SS'))) ~> RederiveColumns",
				"InsertItemData sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     deletable:false,",
				"     insertable:true,",
				"     updateable:false,",
				"     upsertable:false,",
				"     format: 'table',",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     saveOrder: 1,",
				"     stageInsert: true,",
				"     mapColumn(",
				"          DATAAREAID,",
				"          ITEMID,",
				"          PRODUCT,",
				"          ABCVALUE,",
				"          COSTGROUPID,",
				"          DEFAULTDIMENSION,",
				"          CREATEDDATETIME,",
				"          MODIFIEDDATETIME,",
				"          DATAAREA_TIMEZONE,",
				"          ECORESPRODUCTTRANSLATION_PRODUCT,",
				"          ECORESPRODUCTTRANSLATION_NAME,",
				"          ECORESPRODUCTTRANSLATION_MODIFIEDDATETIME,",
				"          BOMCOSTGROUP_DATAAREAID,",
				"          BOMCOSTGROUP_COSTGROUPID,",
				"          BOMCOSTGROUP_NAME,",
				"          BOMCOSTGROUP_COSTGROUPBEHAVIOR,",
				"          BOMCOSTGROUP_COSTGROUPTYPE,",
				"          BOMCOSTGROUP_TYPEDEFAULT,",
				"          DEFAULTDIMENSION_E_CATEGORY,",
				"          DEFAULTDIMENSION_E_CATEGORY_DESCRIPTION_PARENT,",
				"          DEFAULTDIMENSION_E_CATEGORY_DESCRIPTION,",
				"          DEFAULTDIMENSION_F_FAMILY,",
				"          DEFAULTDIMENSION_F_FAMILY_DESCRIPTION,",
				"          DEFAULTDIMENSION_MODIFIEDDATETIME,",
				"          TIMEZONEINFO_TIMEZONEID,",
				"          TIMEZONEINFO_STARTDATE,",
				"          TIMEZONEINFO_ENDDATE,",
				"          TIMEZONEINFO_TIMEBIAS,",
				"          INVENTTABLEMODULE_MODULETYPE,",
				"          INVENTTABLEMODULE_DATAAREAID,",
				"          INVENTTABLEMODULE_ITEMID,",
				"          INVENTTABLEMODULE_UNITID,",
				"          UNITOFMEASURE_RECID,",
				"          UNITOFMEASURE_SYMBOL,",
				"          UNITOFMEASURE_MODIFIEDDATETIME,",
				"          UNITOFMEASURETRANSLATION_UNITOFMEASURE,",
				"          UNITOFMEASURETRANSLATION_DESCRIPTION,",
				"          UNITOFMEASURETRANSLATION_MODIFIEDDATETIME,",
				"          TSIPHITEM_DISPLAYPRODUCTNUMBER,",
				"          TSIPHITEM_BASEITEMID,",
				"          TSIPHITEM_PRODSIZE,",
				"          TSIPHBASEITEM_PGCID,",
				"          TSIPHBASEITEM_BASEITEMDESCRIPTION,",
				"          TSIPHBASEITEM_DEFAULTFDNHIGH,",
				"          TSIPHBASEITEM_DEFAULTFDNLOW,",
				"          TSIPHBASEITEM_DEFAULTFDNMED,",
				"          TSIPHBASEITEM_PIECETYPEID,",
				"          TSIPHBASEITEM_PRICECOLLECTIONID,",
				"          TSIPHGROUP_PLEVELID,",
				"          TSIPHGROUP_PGCDESC,",
				"          TSIPHGROUP_ISACTIVE,",
				"          TSIPHGROUP_EFFECTIVEDATE,",
				"          TSIPHGROUP_EXPIRATIONDATE,",
				"          TSIPHGROUP_MSTRPGCID,",
				"          TSIPHGROUP_COMFORTID,",
				"          TSIPHGROUP_CONSTRUCTID,",
				"          TSIPHLEVEL_LINELAUNCHID,",
				"          TSIPHLEVEL_YOYID,",
				"          TSIPHLEVEL_PLEVELDESC,",
				"          TSIPHLEVEL_ISACTIVE,",
				"          TSIPHLEVEL_ISSPECIALTY,",
				"          TSIPHYEAROVERYEAR_TYPEID,",
				"          TSIPHYEAROVERYEAR_PRICEBANDID,",
				"          TSIPHYEAROVERYEAR_YOYDESC,",
				"          TSIPHTYPE_STYLEID,",
				"          TSIPHTYPE_TECHNOLOGYID,",
				"          TSIPHTYPE_TYPEDESC,",
				"          TSIPHSTYLE_BRANDID,",
				"          TSIPHSTYLE_STYLEDESC,",
				"          TSIPHBRAND_MBRANDID,",
				"          TSIPHBRAND_BRANDDESC,",
				"          TSIPHMASTERBRAND_MBRANDDESC,",
				"          TSIPHTECHNOLOGY_TECHNOLOGYDESC,",
				"          TSIPHPRICEBAND_PRICEBAND,",
				"          TSIPHLINELAUNCH_LINELAUNCHDESC,",
				"          TSIPHCOMFORT_COMFORTDESC,",
				"          TSIPHCONSTRUCTION_CONSTRUCTDESC,",
				"          TSIPHPRICECOLLECTION_PRICECOLLECTIONDESC,",
				"          TPSSIZE_SIZEID,",
				"          TPSSIZE_DIMENSIONS,",
				"          TPSSIZE_EBCPANELLENGTH,",
				"          TPSSIZE_EBCPANELWIDTH,",
				"          TPSSIZE_ACTIVE,",
				"          SIZEGROUP_CD_SIZE = CD_SIZE,",
				"          SIZEGROUP_CODE_SIZE = CODE_SIZE,",
				"          SIZEGROUP_DES_SIZE = DES_SIZE,",
				"          ITEMGROUPID,",
				"          ITEMGROUPNAME,",
				"          LATEST_MODIFIEDDATETIME = LASTEST_MODIFIEDDATETIME,",
				"          HK_JOB_RUN_ID,",
				"          HK_SOURCE_NAME",
				"     ),",
				"     partitionBy('hash', 1)) ~> InsertInventTable",
				"UpsertItemHierarchyData sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     deletable:false,",
				"     insertable:true,",
				"     updateable:true,",
				"     upsertable:false,",
				"     keys:['DISPLAYPRODUCTNUMBER'],",
				"     format: 'table',",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     saveOrder: 2,",
				"     stageInsert: true,",
				"     mapColumn(",
				"          DISPLAYPRODUCTNUMBER = TSIPHITEM_DISPLAYPRODUCTNUMBER,",
				"          BASEITEMID = TSIPHITEM_BASEITEMID,",
				"          PRODSIZE = TSIPHITEM_PRODSIZE,",
				"          PGCID = TSIPHBASEITEM_PGCID,",
				"          BASEITEMDESCRIPTION = TSIPHBASEITEM_BASEITEMDESCRIPTION,",
				"          DEFAULTFDNHIGH = TSIPHBASEITEM_DEFAULTFDNHIGH,",
				"          DEFAULTFDNLOW = TSIPHBASEITEM_DEFAULTFDNLOW,",
				"          DEFAULTFDNMED = TSIPHBASEITEM_DEFAULTFDNMED,",
				"          PIECETYPEID = TSIPHBASEITEM_PIECETYPEID,",
				"          PRICECOLLECTIONID = TSIPHBASEITEM_PRICECOLLECTIONID,",
				"          PLEVELID = TSIPHGROUP_PLEVELID,",
				"          PGCDESC = TSIPHGROUP_PGCDESC,",
				"          TPG_ISACTIVE = TSIPHGROUP_ISACTIVE,",
				"          EFFECTIVEDATE = TSIPHGROUP_EFFECTIVEDATE,",
				"          EXPIRATIONDATE = TSIPHGROUP_EXPIRATIONDATE,",
				"          MSTRPGCID = TSIPHGROUP_MSTRPGCID,",
				"          COMFORTID = TSIPHGROUP_COMFORTID,",
				"          CONSTRUCTID = TSIPHGROUP_CONSTRUCTID,",
				"          LINELAUNCHID = TSIPHLEVEL_LINELAUNCHID,",
				"          YOYID = TSIPHLEVEL_YOYID,",
				"          PLEVELDESC = TSIPHLEVEL_PLEVELDESC,",
				"          TPL_ISACTIVE = TSIPHLEVEL_ISACTIVE,",
				"          ISSPECIALTY = TSIPHLEVEL_ISSPECIALTY,",
				"          TYPEID = TSIPHYEAROVERYEAR_TYPEID,",
				"          PRICEBANDID = TSIPHYEAROVERYEAR_PRICEBANDID,",
				"          YOYDESC = TSIPHYEAROVERYEAR_YOYDESC,",
				"          STYLEID = TSIPHTYPE_STYLEID,",
				"          TECHNOLOGYID = TSIPHTYPE_TECHNOLOGYID,",
				"          TYPEDESC = TSIPHTYPE_TYPEDESC,",
				"          BRANDID = TSIPHSTYLE_BRANDID,",
				"          STYLEDESC = TSIPHSTYLE_STYLEDESC,",
				"          MBRANDID = TSIPHBRAND_MBRANDID,",
				"          BRANDDESC = TSIPHBRAND_BRANDDESC,",
				"          MBRANDDESC = TSIPHMASTERBRAND_MBRANDDESC,",
				"          TECHNOLOGYDESC = TSIPHTECHNOLOGY_TECHNOLOGYDESC,",
				"          PRICEBAND = TSIPHPRICEBAND_PRICEBAND,",
				"          LINELAUNCHDESC = TSIPHLINELAUNCH_LINELAUNCHDESC,",
				"          COMFORTDESC = TSIPHCOMFORT_COMFORTDESC,",
				"          CONSTRUCTDESC = TSIPHCONSTRUCTION_CONSTRUCTDESC,",
				"          PRICECOLLECTIONDESC = TSIPHPRICECOLLECTION_PRICECOLLECTIONDESC,",
				"          SIZEID = TPSSIZE_SIZEID,",
				"          DIMENSIONS = TPSSIZE_DIMENSIONS,",
				"          EBCPANELLENGTH = TPSSIZE_EBCPANELLENGTH,",
				"          EBCPANELWIDTH = TPSSIZE_EBCPANELWIDTH,",
				"          ACTIVE = TPSSIZE_ACTIVE,",
				"          HK_JOB_RUN_ID,",
				"          HK_SOURCE_NAME,",
				"          HK_ITEM_HIERARCHY_HASH_KEY = ITEM_HIERARCHY_HASH_KEY",
				"     )) ~> InventtableHierarchy"
			]
		}
	}
}